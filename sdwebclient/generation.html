<html style="width:99%; height:99%;">
    <head>
        <meta charset="utf-8" />
        <title>ImageGeneration - StableDiffusion</title>
        <link rel="stylesheet" href="css/style.css" />
        <link rel="stylesheet" href="css/anim.css" />
    </head>
    <body style="width:99%; height:99%;">
        <div class="column" style="width:99%; height:99%;">
            <div class="row" style="width:99%; height:65%;">
                <!-- Image results -->
                <div class="center_box" style="width: 100%; overflow: hidden;">
                    <div id="box_results" class="row box_results">


                    </div>
                </div>
                <!-- Controls -->
                <div class="col config_col" >

                    <div class="row">
                        <button onclick="document.getElementById('div_generate_txt2img').style.display='block'; document.getElementById('div_generate_img2img').style.display='none'; ">Txt2Img</button>
                        <button onclick="document.getElementById('div_generate_txt2img').style.display='none'; document.getElementById('div_generate_img2img').style.display='block'; ">Img2Img</button>
                    </div>

                    <div id="div_generate_txt2img">
                        <!-- Prompt text -->
                        <div class="col box_input">
                            <label>Prompt :</label>
                            <input id="input_text" placeholder="The prompt to generate a picture">
                        </div>
                        <!-- Height -->
                        <div class="col box_input">
                            <label>Height: </label>
                            <div class="row">
                                <input id="input_height" type="range" min=64 max=1024 value=512 step="32" oninput="document.getElementById('label_height').innerHTML=document.getElementById('input_height').value;"/>
                                <label id="label_height">512</label>
                            </div>
                        </div>
                        <!-- Width -->
                        <div class="col box_input">
                            <label>Width :</label>
                            <div class="row">
                                <input id="input_width" type="range" min=64 max=1024 value=512 step="32" oninput="document.getElementById('label_width').innerHTML=document.getElementById('input_width').value;"/>
                                <label id="label_width">512</label>
                            </div>
                        </div>
                        <!-- Nb steps -->
                        <div class="col box_input">
                            <label>Number of steps (some doesn't work strangely) :</label>
                            <div class="row">
                                <input id="input_steps" type="range" min=1 max=250 value=50 step="1" oninput="document.getElementById('label_steps').innerHTML=document.getElementById('input_steps').value;"/>
                                <label id="label_steps">50</label>
                            </div>
                        </div>
                        <!-- CFG - Scale ? -->
                        <div class="col box_input" style="display:none;" >
                            <label>CFG-scale :</label>
                            <div class="row">
                                <input id="input_cfg" type="range" min=0 max=20 value=7.5 step=".1" disabled oninput="document.getElementById('label_cfg').innerHTML=document.getElementById('input_cfg').value;"/>
                                <label id="label_cfg">7.5</label>
                            </div>
                        </div>
                        <!-- Nb samples -->
                        <div class="col box_input">
                            <label>Number of samples per iteration :</label>
                            <div class="row">
                                <input id="input_samples" type="range" min=1 max=10 value=5 step="1" oninput="document.getElementById('label_samples').innerHTML=document.getElementById('input_samples').value;"/>
                                <label id="label_samples">5</label>
                            </div>
                        </div>
                        <!-- Nb iterations -->
                        <div class="col box_input">
                            <label>Number of iterations :</label>
                            <div class="row">
                                <input id="input_iterations" type="range" min=1 max=10 value=1 step="1" oninput="document.getElementById('label_iterations').innerHTML=document.getElementById('input_iterations').value;"/>
                                <label id="label_iterations">1</label>
                            </div>
                        </div>
                        <!-- Interaction box -->
                        <div class="col box_input">
                            <!-- Button -->
                            <div id="button_t2i">
                                <button class="bt1" onclick="generate_txt2img();">Generate</button>
                            </div>
                            <!-- Sending Informations -->
                            <div id="sending_informations_t2i" class="row" style="display:none;">
                                <div>
                                    <p>Sending informations to the server</p>
                                </div>
                                <div class="lds-facebook"><div></div><div></div><div></div></div>
                            </div>
                            <!-- Generating -->
                            <div id="generating_t2i" class="row" style="display:none;">
                                <div>
                                    <p>Generating</p>
                                </div>
                                <div class="lds-ellipsis"><div></div><div></div><div></div><div></div></div>
                            </div>
                            <!-- Error -->
                            <div id="error_t2i" class="col" style="display:none; text-align: center;" onclick="document.getElementById('button_t2i').style.display='block'; this.style.display='none';">
                                <p>There was an error while generating the image</p>
                                <label>(Click to dismiss the message)</label>
                            </div>
                            <!-- Generated -->
                            <div id="generated_t2i" class="col" style="display:none; text-align: center;" onclick="document.getElementById('button_t2i').style.display='block'; this.style.display='none';">
                                <p>Images generated</p>
                                <label>(Click to dismiss the message)</label>
                            </div>
                        </div>
                    </div>

                    
                    <div id="div_generate_img2img" style="display:none;">
                        <!-- Img init -->
                        <div class="col box_input">
                            <label>ImgInit :</label>
                            <input id="input_imginit" type="file" oninput="previewFile();">
                            <img id="img_preview" />
                        </div>
                        <!-- Prompt text -->
                        <div class="col box_input">
                            <label>Prompt :</label>
                            <input id="input_text2" placeholder="The prompt to generate a picture">
                        </div>
                        <!-- Height -->
                        <div class="col box_input">
                            <label>Height: </label>
                            <div class="row">
                                <input id="input_height2" type="range" min=64 max=1024 value=512 step="32" oninput="document.getElementById('label_height2').innerHTML=document.getElementById('input_height2').value;"/>
                                <label id="label_height2">512</label>
                            </div>
                        </div>
                        <!-- Width -->
                        <div class="col box_input">
                            <label>Width :</label>
                            <div class="row">
                                <input id="input_width2" type="range" min=64 max=1024 value=512 step="32" oninput="document.getElementById('label_width2').innerHTML=document.getElementById('input_width2').value;"/>
                                <label id="label_width2">512</label>
                            </div>
                        </div>
                        <!-- Strength -->
                        <div class="col box_input">
                            <label>Strength :</label>
                            <div class="row">
                                <input id="input_strength" type="range" min=0 max=1 value=0.75 step="0.01" oninput="document.getElementById('label_strength').innerHTML=document.getElementById('input_strength').value;"/>
                                <label id="label_strength">1</label>
                            </div>
                        </div>
                        <!-- Nb steps -->
                        <div class="col box_input">
                            <label>Number of steps (some doesn't work strangely) :</label>
                            <div class="row">
                                <input id="input_steps2" type="range" min=1 max=250 value=35 step="1" oninput="document.getElementById('label_steps2').innerHTML=document.getElementById('input_steps2').value;"/>
                                <label id="label_steps2">35</label>
                            </div>
                        </div>
                        <!-- Nb samples -->
                        <div class="col box_input">
                            <label>Number of samples per iteration :</label>
                            <div class="row">
                                <input id="input_samples2" type="range" min=0 max=10 value=5 step="1" oninput="document.getElementById('label_samples2').innerHTML=document.getElementById('input_samples2').value;"/>
                                <label id="label_samples2">5</label>
                            </div>
                        </div>
                        <!-- Nb iterations -->
                        <div class="col box_input">
                            <label>Number of iterations :</label>
                            <div class="row">
                                <input id="input_iterations2" type="range" min=1 max=10 value=1 step="1" oninput="document.getElementById('label_iterations2').innerHTML=document.getElementById('input_iterations2').value;"/>
                                <label id="label_iterations2">1</label>
                            </div>
                        </div>
                        
                        <!-- Interaction box -->
                        <div class="col box_input">
                            <!-- Button -->
                            <div id="button_i2i">
                                <button class="bt1" onclick="generate_img2img();">Generate</button>
                            </div>
                            <!-- Sending Informations -->
                            <div id="sending_informations_i2i" class="row" style="display:none;">
                                <div>
                                    <p>Sending informations to the server</p>
                                </div>
                                <div class="lds-facebook"><div></div><div></div><div></div></div>
                            </div>
                            <!-- Generating -->
                            <div id="generating_i2i" class="row" style="display:none;">
                                <div>
                                    <p>Generating</p>
                                </div>
                                <div class="lds-ellipsis"><div></div><div></div><div></div><div></div></div>
                            </div>
                            <!-- Error -->
                            <div id="error_i2i" class="col" style="display:none; text-align: center;" onclick="document.getElementById('button_i2i').style.display='block'; this.style.display='none';">
                                <p>There was an error while generating the image</p>
                                <label>(Click to dismiss the message)</label>
                            </div>
                            <!-- Generated -->
                            <div id="generated_i2i" class="col" style="display:none; text-align: center;" onclick="document.getElementById('button_i2i').style.display='block'; this.style.display='none';">
                                <p>Images generated</p>
                                <label>(Click to dismiss the message)</label>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
            <!-- Console / History div -->
            <div class="col bottom_div" style="display:none;">
                <!-- Buttons -->
                <div class="row" style="border-collapse:collapse;">
                    <button onclick="document.getElementById('div_prompts').style.display='block'; document.getElementById('div_console').style.display='none';">prompts</button>
                    <button onclick="document.getElementById('div_console').style.display='block'; document.getElementById('div_prompts').style.display='none';">console</button>
                </div>
                <!-- Divs -->
                <div class="col" id="div_prompts"></div>
                <div class="col" id="div_console" style="display:none;">
                    <p style="color: red;">ERROR : cannot connect to the computer !</p>
                </div>
            </div>
        </div>
    </body>
</html>
<script src="js/websocket_client.js"></script>
<script>

window.img = null;
window.img_width = null;
window.img_height = null;

const queryString = window.location.search;
const urlParams = new URLSearchParams(queryString);

const IP = urlParams.get("IP");
const PORT = urlParams.get("PORT");

start_websocket(IP, PORT);

function getRandomInt(max) {
  return Math.floor(Math.random() * max);
}

function generate_txt2img(){
    if(window.state == 1){return;}
    var prompt = document.getElementById("input_text").value;
    var H = document.getElementById("input_height").value;
    var W = document.getElementById("input_width").value;
    var ddim_steps = document.getElementById("input_steps").value;
    var nb_samples = document.getElementById("input_samples").value;
    var nb_iter = document.getElementById("input_iterations").value;
    //seed = document.getElementById("input_seed").value;
    var seed = getRandomInt(9999999);
    //
    ws_send({
        "action": "generate_txt2img",
        "txt": prompt,
        "height": H,
        "width": W,
        "ddim_steps": ddim_steps,
        "nb_samples": nb_samples,
        "nb_iter": nb_iter,
        "seed": seed
    })
    window.state = 1;
    document.getElementById("button_t2i").style.display = "none";
    document.getElementById("sending_informations_t2i").style.display = "flex";
    document.getElementById("generating_t2i").style.display = "none";
    document.getElementById("error_t2i").style.display = "none";
    document.getElementById("generated_t2i").style.display = "none";
}


function generate_img2img(){
    if(window.state == 1){return;}
    var bon = false;
    var s = document.getElementById("img_preview").src;
    if(s.startsWith("data:image/png;base64,")){
        window.img = s.substring(22, s.length);
        bon = true;
    }
    else if(s.startsWith("data:image/jpeg;base64,")){
        window.img = s.substring(23, s.length);
        bon = true;
    }
    if(!bon){
        alert("Il y a eu une erreur lors de la récupération de l'image dont vous voulez générer des variations !");
        return;
    }
    var prompt = document.getElementById("input_text2").value;
    var ddim_steps = document.getElementById("input_steps2").value;
    var nb_samples = document.getElementById("input_samples2").value;
    var nb_iter = document.getElementById("input_iterations2").value;
    var strength = document.getElementById("input_strength").value;
    var H = document.getElementById("input_height2").value;
    var W = document.getElementById("input_width2").value;
    var seed = getRandomInt(9999999);
    //
    ws_send({
        "action": "generate_img2img",
        "txt": prompt,
        "strength": strength,
        "ddim_steps": ddim_steps,
        "nb_samples": nb_samples,
        "nb_iter": nb_iter,
        "seed": seed,
        "init_img": window.img,
        "width": W,
        "height": H
    })
    window.state = 1;
    document.getElementById("button_i2i").style.display = "none";
    document.getElementById("sending_informations_i2i").style.display = "flex";
    document.getElementById("generating_i2i").style.display = "none";
    document.getElementById("error_i2i").style.display = "none";
    document.getElementById("generated_i2i").style.display = "none";
}

function previewFile() {
  const preview = document.getElementById("img_preview");
  const file = document.getElementById("input_imginit").files[0];
  const reader = new FileReader();

  reader.addEventListener("load", () => {
    // on convertit l'image en une chaîne de caractères base64
    preview.src = reader.result;
    window.img_height = preview.naturalHeight;
    window.img_width = preview.naturalWidth;
    document.getElementById("input_width2").value = window.img_width;
    document.getElementById("input_height2").value = window.img_height;
    document.getElementById("label_width2").innerHTML = window.img_width;
    document.getElementById("label_height2").innerHTML = window.img_height;
  }, false);

  if (file) {
    reader.readAsDataURL(file);
    window.img = reader.result;
  }
}

function encode (input) {
    var keyStr = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";
    var output = "";
    var chr1, chr2, chr3, enc1, enc2, enc3, enc4;
    var i = 0;

    while (i < input.length) {
        chr1 = input[i++];
        chr2 = i < input.length ? input[i++] : Number.NaN; // Not sure if the index
        chr3 = i < input.length ? input[i++] : Number.NaN; // checks are needed here

        enc1 = chr1 >> 2;
        enc2 = ((chr1 & 3) << 4) | (chr2 >> 4);
        enc3 = ((chr2 & 15) << 2) | (chr3 >> 6);
        enc4 = chr3 & 63;

        if (isNaN(chr2)) {
            enc3 = enc4 = 64;
        } else if (isNaN(chr3)) {
            enc4 = 64;
        }
        output += keyStr.charAt(enc1) + keyStr.charAt(enc2) +
                  keyStr.charAt(enc3) + keyStr.charAt(enc4);
    }
    return output;
}

function aff_imgs(lst_imgs){
    var arrayBuffer;

    // Clear
    var br = document.getElementById("box_results");
    br.innerHTML = "";
    // Load imgs
    for(i of lst_imgs){
        var im = document.createElement("img");
        var sub = i.substring(2, i.length-1);

        im.src = "data:image/png;base64,"+sub;
        im.classList.add("img_result");

        br.appendChild(im);
    }
}

window.state = 0; // 0 = repos ; 1 = waiting

window.onload = function(){
    document.getElementById("label_iterations2").innerHTML=document.getElementById('input_iterations2').value;
    document.getElementById("label_samples2").innerHTML=document.getElementById('input_samples2').value;
    document.getElementById("label_steps2").innerHTML=document.getElementById('input_steps2').value;
    document.getElementById("label_strength").innerHTML=document.getElementById('input_strength').value;
    document.getElementById("label_iterations").innerHTML=document.getElementById('input_iterations').value;
    document.getElementById("label_samples").innerHTML=document.getElementById('input_samples').value;
    document.getElementById("label_cfg").innerHTML=document.getElementById('input_cfg').value;
    document.getElementById("label_steps").innerHTML=document.getElementById('input_steps').value;
    document.getElementById("label_width").innerHTML=document.getElementById('input_width').value;
    document.getElementById("label_height").innerHTML=document.getElementById('input_height').value;
}

</script>